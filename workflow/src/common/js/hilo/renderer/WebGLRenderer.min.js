/**
 * Hilo 1.0.1 for commonjs
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
var Class=require("../core/Class"),Renderer=require("./Renderer"),Matrix=require("../geom/Matrix"),DEG2RAD=Math.PI/180,WebGLRenderer=Class.create({Extends:Renderer,Statics:{MAX_BATCH_NUM:2e3,ATTRIBUTE_NUM:5,isSupported:null},renderType:"webgl",gl:null,constructor:function(e){window.__render=this,WebGLRenderer.superclass.constructor.call(this,e);var t=this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");this.maxBatchNum=WebGLRenderer.MAX_BATCH_NUM,this.positionStride=4*WebGLRenderer.ATTRIBUTE_NUM;var r=this.maxBatchNum*WebGLRenderer.ATTRIBUTE_NUM*4,a=6*this.maxBatchNum;this.positions=new Float32Array(r),this.indexs=new Uint16Array(a);for(var i=0,n=0;a>i;i+=6,n+=4)this.indexs[i+0]=n+0,this.indexs[i+1]=n+1,this.indexs[i+2]=n+2,this.indexs[i+3]=n+1,this.indexs[i+4]=n+2,this.indexs[i+5]=n+3;this.batchIndex=0,this.sprites=[],t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.clearColor(0,0,0,0),t.disable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.enable(t.BLEND),this._initShaders(),this.defaultShader.active(),this.positionBuffer=t.createBuffer(),this.indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indexs,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,this.positions,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.a_position,2,t.FLOAT,!1,this.positionStride,0),t.vertexAttribPointer(this.a_TexCoord,2,t.FLOAT,!1,this.positionStride,8),t.vertexAttribPointer(this.a_alpha,1,t.FLOAT,!1,this.positionStride,16)},context:null,startDraw:function(e){return e.visible&&e.alpha>0?(e===this.stage&&this.clear(),!0):!1},draw:function(e){var t=(this.context,e.width),r=e.height,a=(e.background,e.drawable),i=a&&a.image;if(i){this.gl;i.texture||this.activeShader.uploadTexture(i);var n=a.rect,s=n[2],o=n[3];n[4],n[5];t||r||(t=e.width=s,r=e.height=o),this.batchIndex>=this.maxBatchNum&&this._renderBatches();var h=this._createVertexs(i,n[0],n[1],s,o,0,0,t,r),l=this.batchIndex*this.positionStride,d=this.positions,c=e.__webglRenderAlpha;d[l+0]=h[0],d[l+1]=h[1],d[l+2]=h[2],d[l+3]=h[3],d[l+4]=c,d[l+5]=h[4],d[l+6]=h[5],d[l+7]=h[6],d[l+8]=h[7],d[l+9]=c,d[l+10]=h[8],d[l+11]=h[9],d[l+12]=h[10],d[l+13]=h[11],d[l+14]=c,d[l+15]=h[12],d[l+16]=h[13],d[l+17]=h[14],d[l+18]=h[15],d[l+19]=c;for(var _=e.__webglWorldMatrix,u=0;4>u;u++){var f=d[l+5*u],x=d[l+5*u+1];d[l+5*u]=_.a*f+_.c*x+_.tx,d[l+5*u+1]=_.b*f+_.d*x+_.ty}e.texture=i.texture,this.sprites[this.batchIndex++]=e}},endDraw:function(e){e===this.stage&&this._renderBatches()},transform:function(e){var t=e.drawable;if(t&&t.domElement)return void Hilo.setElementStyleByView(e);var r=(this.context,e.scaleX),a=e.scaleY;if(e===this.stage){var i=this.canvas.style,n=e._scaleX,s=e._scaleY;(!n&&1!=r||n&&n!=r)&&(e._scaleX=r,i.width=r*e.width+"px"),(!s&&1!=a||s&&s!=a)&&(e._scaleY=a,i.height=a*e.height+"px"),e.__webglWorldMatrix=e.__webglWorldMatrix||new Matrix(1,0,0,1,0,0)}else e.__webglWorldMatrix=e.__webglWorldMatrix||new Matrix(1,0,0,1,0,0),this._setConcatenatedMatrix(e,e.parent);e.alpha>0&&(e.parent&&e.parent.__webglRenderAlpha?e.__webglRenderAlpha=e.alpha*e.parent.__webglRenderAlpha:e.__webglRenderAlpha=e.alpha)},remove:function(e){var t=e.drawable,r=t&&t.domElement;if(r){var a=r.parentNode;a&&a.removeChild(r)}},clear:function(e,t,r,a){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},resize:function(e,t){this.width===e&&this.height===t||(this.width=this.canvas.width=e,this.height=this.canvas.height=t,this.gl.viewport(0,0,e,t),this.canvasHalfWidth=.5*e,this.canvasHalfHeight=.5*t,this._uploadProjectionTransform(!0))},_renderBatches:function(){var e=this.gl;e.bufferSubData(e.ARRAY_BUFFER,0,this.positions.subarray(0,this.batchIndex*this.positionStride));for(var t=0,r=0,a=null,i=0;i<this.batchIndex;i++){var n=this.sprites[i];a&&a!==n.texture&&(this._renderBatch(t,i),t=i,r=1),a=n.texture}this._renderBatch(t,this.batchIndex),this.batchIndex=0},_renderBatch:function(e,t){var r=this.gl,a=t-e;a>0&&(r.bindTexture(r.TEXTURE_2D,this.sprites[e].texture),r.drawElements(r.TRIANGLES,6*a,r.UNSIGNED_SHORT,6*e*2))},_uploadProjectionTransform:function(e){this._projectionTransformElements&&!e||(this._projectionTransformElements=new Float32Array([1/this.canvasHalfWidth,0,0,0,-1/this.canvasHalfHeight,0,-1,1,1])),this.gl.uniformMatrix3fv(this.u_projectionTransform,!1,this._projectionTransformElements)},_initShaders:function(){var e="            attribute vec2 a_position;\n            attribute vec2 a_TexCoord;\n            attribute float a_alpha;\n            uniform mat3 u_projectionTransform;\n            varying vec2 v_TexCoord;\n            varying float v_alpha;\n            void main(){\n                gl_Position =  vec4((u_projectionTransform * vec3(a_position, 1.0)).xy, 1.0, 1.0);\n                v_TexCoord = a_TexCoord;\n                v_alpha = a_alpha;\n            }\n        ",t="\n            precision mediump float;\n            uniform sampler2D u_Sampler;\n            varying vec2 v_TexCoord;\n            varying float v_alpha;\n            void main(){\n                gl_FragColor = texture2D(u_Sampler, v_TexCoord) * v_alpha;\n            }\n        ";this.defaultShader=new Shader(this,{v:e,f:t},{attributes:["a_position","a_TexCoord","a_alpha"],uniforms:["u_projectionTransform","u_Alpha","u_Sampler"]})},_createVertexs:function(e,t,r,a,i,n,s,o,h){var l=this.__tempVertexs||[],d=e.width,c=e.height;a/=d,i/=c,t/=d,r/=c,o=o,h=h,n=n,s=s,a+t>1&&(a=1-t),i+r>1&&(i=1-r);var _=0;return l[_++]=n,l[_++]=s,l[_++]=t,l[_++]=r,l[_++]=n+o,l[_++]=s,l[_++]=t+a,l[_++]=r,l[_++]=n,l[_++]=s+h,l[_++]=t,l[_++]=r+i,l[_++]=n+o,l[_++]=s+h,l[_++]=t+a,l[_++]=r+i,l},_setConcatenatedMatrix:function(e,t){var r=e.__webglWorldMatrix,a=1,i=0,n=e.rotation%360,s=e.pivotX,o=e.pivotY,h=e.scaleX,l=e.scaleY;if(n){var d=n*DEG2RAD;a=Math.cos(d),i=Math.sin(d)}r.a=a*h,r.b=i*h,r.c=-i*l,r.d=a*l,r.tx=e.x-r.a*s-r.c*o,r.ty=e.y-r.b*s-r.d*o,r.concat(t.__webglWorldMatrix)}}),_cacheTexture={},Shader=function(e,t,r){this.renderer=e,this.gl=e.gl,this.program=this._createProgram(this.gl,t.v,t.f),r=r||{},this.attributes=r.attributes||[],this.uniforms=r.uniforms||[]};Shader.prototype={active:function(){var e=this,t=e.renderer,r=e.gl,a=e.program;a&&r&&(t.activeShader=e,r.useProgram(a),e.attributes.forEach(function(e){t[e]=r.getAttribLocation(a,e),r.enableVertexAttribArray(t[e])}),e.uniforms.forEach(function(e){t[e]=r.getUniformLocation(a,e)}),e.width===t.width&&e.height===t.height||(e.width=t.width,e.height=t.height,t._uploadProjectionTransform()))},uploadTexture:function(e){var t=this.gl,r=this.renderer;if(_cacheTexture[e.src])e.texture=_cacheTexture[e.src];else{var a=t.createTexture(),i=r.u_Sampler;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,a),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.uniform1i(i,0),t.bindTexture(t.TEXTURE_2D,null),e.texture=a,_cacheTexture[e.src]=a}},_createProgram:function(e,t,r){var a=this._createShader(e,e.VERTEX_SHADER,t),i=this._createShader(e,e.FRAGMENT_SHADER,r);if(!a||!i)return null;var n=e.createProgram();if(n){e.attachShader(n,a),e.attachShader(n,i),e.linkProgram(n),e.deleteShader(i),e.deleteShader(a);var s=e.getProgramParameter(n,e.LINK_STATUS);if(!s){var o=e.getProgramInfoLog(n);return console.log("Failed to link program: "+o),e.deleteProgram(n),null}}return n},_createShader:function(e,t,r){var a=e.createShader(t);if(a){e.shaderSource(a,r),e.compileShader(a);var i=e.getShaderParameter(a,e.COMPILE_STATUS);if(!i){var n=e.getShaderInfoLog(a);return console.log("Failed to compile shader: "+n),e.deleteShader(a),null}}return a}},WebGLRenderer.isSupported=function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}(),module.exports=WebGLRenderer;